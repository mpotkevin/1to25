<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1-25 èˆ’çˆ¾ç‰¹æ¯æ—¥ç·´ç¿’ (GitHub éƒ¨ç½²ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /**
         * ã€é‡è¦ï¼šå¦‚æœä½ è¦éƒ¨ç½²åˆ° GitHubï¼Œè«‹å¡«å¯«ä»¥ä¸‹è³‡è¨Šã€‘
         * 1. åˆ° Firebase Console å»ºç«‹å°ˆæ¡ˆ
         * 2. é»æ“Šã€Œæ–°å¢æ‡‰ç”¨ç¨‹å¼ (Web)ã€
         * 3. è¤‡è£½ç”¢ç”Ÿçš„ config ç‰©ä»¶ä¸¦è²¼åœ¨ä¸‹æ–¹
         */
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "ä½ çš„_API_KEY",
            authDomain: "ä½ çš„_å°ˆæ¡ˆID.firebaseapp.com",
            projectId: "ä½ çš„_å°ˆæ¡ˆID",
            storageBucket: "ä½ çš„_å°ˆæ¡ˆID.appspot.com",
            messagingSenderId: "ä½ çš„_ç™¼é€è€…ID",
            appId: "ä½ çš„_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // å¦‚æœæ˜¯åœ¨ GitHubï¼Œå»ºè­°å°‡ appId æ”¹æˆä¸€å€‹å›ºå®šçš„å­—ä¸²ï¼Œä¾‹å¦‚ "my-schulte-game"
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'schulte-production-v1';

        let user = null;
        let nextNumber = 1;
        let timerInterval = null;
        let startTime = null;
        let isGameActive = false;
        let myScores = [];
        let allScores = [];
        let clickCount = 0;
        let clickTimer = null;

        const grid = document.getElementById('game-grid');
        const timerDisplay = document.getElementById('timer');
        const nextTargetDisplay = document.getElementById('next-target');
        const resetBtn = document.getElementById('reset-btn');
        const resultModal = document.getElementById('result-modal');
        const finalTimeDisplay = document.getElementById('final-time');
        const historyList = document.getElementById('history-list');
        const bestTimeDisplay = document.getElementById('best-time');
        const syncStatus = document.getElementById('sync-status');
        const adminDashboard = document.getElementById('admin-dashboard');
        const adminTableBody = document.getElementById('admin-table-body');
        const passwordModal = document.getElementById('password-modal');
        const adminPassInput = document.getElementById('admin-pass-input');

        // --- 1. èº«ä»½é©—è­‰èˆ‡åˆå§‹åŒ– ---
        const initAuth = async () => {
            syncStatus.textContent = "â³ é€£ç·šä¸­...";
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                syncStatus.textContent = "âŒ é€£ç·šå¤±æ•—";
            }
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                syncStatus.textContent = "âœ… å·²é€£ç·š (ID: " + user.uid.substring(0, 5) + ")";
                loadMyScores();
                loadAllScores();
            }
        });

        // --- 2. Firestore è³‡æ–™è™•ç† ---
        function loadMyScores() {
            if (!user) return;
            const scoresRef = collection(db, 'artifacts', appId, 'users', user.uid, 'scores');
            onSnapshot(scoresRef, (snap) => {
                myScores = snap.docs.map(d => d.data());
                myScores.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderHistory();
            });
        }

        function loadAllScores() {
            if (!user) return;
            const allScoresRef = collection(db, 'artifacts', appId, 'public', 'data', 'all_scores');
            onSnapshot(allScoresRef, (snap) => {
                allScores = snap.docs.map(d => d.data());
                allScores.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderAdminTable();
            }, (err) => { /* å¿½ç•¥æ¬Šé™éŒ¯èª¤ */ });
        }

        async function saveScore(time) {
            if (!user) return;
            const data = {
                uid: user.uid,
                time: parseFloat(time),
                timestamp: serverTimestamp(),
                dateStr: new Date().toLocaleString('zh-TW', { hour12: false })
            };
            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'scores'), data);
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'all_scores'), data);
            } catch (e) { console.error(e); }
        }

        // --- 3. UI æ¸²æŸ“ ---
        function renderHistory() {
            historyList.innerHTML = '';
            if (myScores.length > 0) {
                const times = myScores.map(s => s.time).filter(t => !isNaN(t));
                if (times.length > 0) bestTimeDisplay.textContent = Math.min(...times).toFixed(2) + 's';
                myScores.slice(0, 5).forEach(s => {
                    const div = document.createElement('div');
                    div.className = "flex justify-between py-2 border-b border-black/5 last:border-0 text-sm";
                    div.innerHTML = `<span class="text-slate-500 text-xs">${s.dateStr ? s.dateStr.split(' ')[0] : 'ç´€éŒ„ä¸­'}</span><span class="font-bold text-slate-800">${s.time.toFixed(2)}s</span>`;
                    historyList.appendChild(div);
                });
            } else {
                historyList.innerHTML = '<p class="text-slate-400 text-xs text-center py-4">å°šç„¡ç´€éŒ„</p>';
            }
        }

        function renderAdminTable() {
            adminTableBody.innerHTML = '';
            allScores.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-100 text-[10px]";
                tr.innerHTML = `<td class="p-2 font-mono">${s.uid.substring(0,8)}</td><td class="p-2">${s.dateStr}</td><td class="p-2 font-bold text-right text-blue-600">${s.time.toFixed(2)}s</td>`;
                adminTableBody.appendChild(tr);
            });
        }

        // --- 4. éš±è—å¾Œå°è§¸ç™¼ ---
        window.handleTitleClick = () => {
            syncStatus.classList.add('opacity-0');
            setTimeout(() => syncStatus.classList.remove('opacity-0'), 100);
            clickCount++;
            clearTimeout(clickTimer);
            if (clickCount >= 5) {
                clickCount = 0;
                passwordModal.classList.remove('hidden');
                adminPassInput.focus();
            } else {
                clickTimer = setTimeout(() => { clickCount = 0; }, 3000);
            }
        };

        window.submitPassword = () => {
            if (adminPassInput.value === "8888") {
                passwordModal.classList.add('hidden');
                adminDashboard.classList.remove('hidden');
                adminDashboard.scrollIntoView({ behavior: 'smooth' });
                adminPassInput.value = "";
            } else {
                const errorMsg = document.getElementById('pass-error');
                errorMsg.classList.remove('hidden');
                setTimeout(() => errorMsg.classList.add('hidden'), 2000);
                adminPassInput.value = "";
            }
        };

        window.closePasswordModal = () => {
            passwordModal.classList.add('hidden');
            adminPassInput.value = "";
        };

        window.copyAllToCSV = () => {
            let csv = "ç©å®¶ID,æ—¥æœŸ,æˆç¸¾\n";
            allScores.forEach(s => csv += `${s.uid},${s.dateStr},${s.time}\n`);
            const el = document.createElement('textarea');
            el.value = csv; document.body.appendChild(el); el.select();
            document.execCommand('copy'); document.body.removeChild(el);
            const copyBtn = document.querySelector('button[onclick="copyAllToCSV()"]');
            copyBtn.innerText = "âœ… å·²è¤‡è£½";
            setTimeout(() => copyBtn.innerText = "è¤‡è£½ CSV", 2000);
        };

        // --- 5. éŠæˆ²é‚è¼¯ ---
        function startGame() {
            nextNumber = 1; isGameActive = false; clearInterval(timerInterval);
            timerDisplay.textContent = '0.00s'; nextTargetDisplay.textContent = '1'; resultModal.classList.add('hidden');
            const nums = Array.from({length: 25}, (_, i) => i + 1);
            for (let i = nums.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [nums[i], nums[j]] = [nums[j], nums[i]];
            }
            grid.innerHTML = '';
            nums.forEach(num => {
                const btn = document.createElement('button');
                btn.className = 'number-btn';
                btn.textContent = num;
                btn.onclick = () => {
                    if (num === nextNumber) {
                        if (nextNumber === 1) {
                            isGameActive = true; startTime = Date.now();
                            timerInterval = setInterval(() => {
                                timerDisplay.textContent = ((Date.now() - startTime) / 1000).toFixed(2) + 's';
                            }, 10);
                        }
                        btn.style.visibility = 'hidden';
                        nextNumber++;
                        if (nextNumber > 25) {
                            clearInterval(timerInterval);
                            const final = timerDisplay.textContent.replace('s', '');
                            finalTimeDisplay.textContent = final + 's';
                            saveScore(final);
                            setTimeout(() => resultModal.classList.remove('hidden'), 200);
                        } else { nextTargetDisplay.textContent = nextNumber; }
                    } else if (isGameActive) {
                        btn.classList.add('wrong');
                        setTimeout(() => btn.classList.remove('wrong'), 200);
                    }
                };
                grid.appendChild(btn);
            });
        }

        window.onload = () => { initAuth(); startGame(); resetBtn.onclick = startGame; document.getElementById('modal-close').onclick = startGame; };
    </script>
    <style>
        body { background-color: #F2D64B; touch-action: manipulation; }
        .number-btn {
            aspect-ratio: 1/1; background: white; border-radius: 12px; font-weight: 800; font-size: 1.5rem;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1); transition: all 0.1s;
        }
        .number-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }
        .number-btn.wrong { background-color: #fee2e2; animation: shake 0.2s; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)} }
        .card { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 20px; padding: 1.25rem; box-shadow: 0 8px 20px -5px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="p-4 flex flex-col items-center min-h-screen">

    <div class="w-full max-w-md">
        <header class="flex justify-between items-end mb-4 px-1 cursor-pointer select-none" onclick="handleTitleClick()">
            <div>
                <h1 class="text-2xl font-black text-slate-900 leading-none">1-25 æŒ‘æˆ°</h1>
                <p id="sync-status" class="text-[10px] font-bold mt-1 uppercase text-slate-600 transition-opacity duration-75">â³ é€£ç·šä¸­...</p>
            </div>
            <div class="text-right">
                <p class="text-[10px] font-bold text-slate-500 uppercase">å€‹äººæœ€ä½³</p>
                <p id="best-time" class="text-xl font-black text-blue-600 leading-none">--.--s</p>
            </div>
        </header>

        <div class="grid grid-cols-2 gap-3 mb-4 text-center">
            <div class="card"><div class="text-[10px] font-bold text-slate-400 uppercase mb-1">ç›®æ¨™</div><div id="next-target" class="text-3xl font-black text-blue-600">1</div></div>
            <div class="card"><div class="text-[10px] font-bold text-slate-400 uppercase mb-1">ç”¨æ™‚</div><div id="timer" class="text-3xl font-black text-slate-900">0.00s</div></div>
        </div>

        <div id="game-grid" class="grid grid-cols-5 gap-2 mb-6"></div>

        <button id="reset-btn" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold mb-8 active:scale-95 shadow-lg text-lg">é‡æ–°é–‹å§‹</button>

        <div class="card mb-6">
            <h3 class="font-bold text-slate-800 mb-3 text-sm">ğŸ•’ æœ€è¿‘ 5 æ¬¡æˆç¸¾</h3>
            <div id="history-list" class="min-h-[60px]"></div>
        </div>

        <!-- ç®¡ç†å“¡å¾Œå° (éš±è—) -->
        <div id="admin-dashboard" class="card hidden border-2 border-slate-900 mt-4 bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black text-slate-900 text-sm">ç®¡ç†å“¡ï¼šå…¨é«”æ•¸æ“š</h3>
                <button onclick="copyAllToCSV()" class="bg-green-600 text-white text-[10px] px-3 py-1 rounded-full font-bold shadow-sm">è¤‡è£½ CSV</button>
            </div>
            <div class="max-h-60 overflow-y-auto rounded-lg bg-slate-50 border border-slate-200">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-200 text-[9px] font-bold sticky top-0">
                        <tr>
                            <th class="p-2">ç©å®¶ ID</th>
                            <th class="p-2">æ—¥æœŸ</th>
                            <th class="p-2 text-right">æˆç¸¾</th>
                        </tr>
                    </thead>
                    <tbody id="admin-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- å¯†ç¢¼è¼¸å…¥æ¨¡æ…‹è¦–çª— -->
    <div id="password-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center p-6 z-[60]">
        <div class="bg-white rounded-3xl p-8 max-w-xs w-full text-center shadow-2xl">
            <h3 class="text-xl font-bold text-slate-900 mb-4">ç®¡ç†å“¡é©—è­‰</h3>
            <input type="password" id="admin-pass-input" placeholder="è¼¸å…¥å¯†ç¢¼" class="w-full p-4 border-2 border-slate-200 rounded-xl mb-4 text-center text-lg focus:border-blue-500 outline-none">
            <p id="pass-error" class="text-red-500 text-xs mb-4 hidden">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closePasswordModal()" class="py-3 bg-slate-100 text-slate-600 rounded-xl font-bold">å–æ¶ˆ</button>
                <button onclick="submitPassword()" class="py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-200">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- éŠæˆ²çµç®—è¦–çª— -->
    <div id="result-modal" class="fixed inset-0 bg-slate-900/90 backdrop-blur-md hidden flex items-center justify-center p-6 z-50">
        <div class="bg-white rounded-[40px] p-10 max-w-sm w-full text-center shadow-2xl">
            <div class="text-5xl mb-6">ğŸ†</div>
            <h2 class="text-2xl font-black text-slate-900 mb-2">åŠŸèª²å®Œæˆï¼</h2>
            <div id="final-time" class="text-6xl font-black text-blue-600 mb-10">0.00s</div>
            <button id="modal-close" class="w-full py-5 bg-blue-600 text-white rounded-2xl font-bold text-xl active:scale-95">å†ä¾†ä¸€å±€</button>
        </div>
    </div>

</body>
</html>
